---
# Playbook: Basic VM Setup
# - Set hostname
# - Config static IP
# - Set timezone to Asia/Ho_Chi_Minh (UTC+7)
# - Mount data disk (if exists)

- name: Setup VM
  hosts: all
  become: true

  tasks:
    # ===== Timezone =====
    - name: Set timezone to Asia/Ho_Chi_Minh (UTC+7)
      timezone:
        name: Asia/Ho_Chi_Minh

    - name: Sync system time
      command: timedatectl set-ntp true

    # ===== Hostname =====
    - name: Set hostname
      hostname:
        name: "{{ vm_hostname }}"
      when: vm_hostname is defined

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ vm_hostname }}"
      when: vm_hostname is defined

    # ===== Static IP =====
    - name: Get primary network interface
      shell: ip route | grep default | awk '{print $5}' | head -1
      register: primary_interface
      changed_when: false
      when: static_ip is defined

    - name: Show detected interface
      debug:
        msg: "Primary interface: {{ primary_interface.stdout }}"
      when: static_ip is defined

    - name: Create netplan config
      copy:
        dest: /etc/netplan/00-static-ip.yaml
        content: |
          network:
            version: 2
            ethernets:
              {{ primary_interface.stdout }}:
                addresses:
                  - {{ static_ip }}
                routes:
                  - to: default
                    via: {{ gateway }}
                nameservers:
                  addresses:
                    - 8.8.8.8
                    - 1.1.1.1
        mode: "0600"
      when: static_ip is defined
      register: netplan_config

    - name: Remove old netplan configs
      shell: find /etc/netplan -name "*.yaml" ! -name "00-static-ip.yaml" -delete
      when: netplan_config.changed

    - name: Apply netplan
      command: netplan apply
      async: 45
      poll: 0
      when: netplan_config.changed

    - name: Wait for network to stabilize
      pause:
        seconds: 10
      when: netplan_config.changed

    - name: Test new IP connectivity
      wait_for:
        host: "{{ static_ip | regex_replace('/.*', '') }}"
        port: 22
        delay: 5
        timeout: 60
        state: started
      delegate_to: localhost
      when: netplan_config.changed

    # ===== Data Disk =====
    - name: Check if data disk exists
      stat:
        path: "{{ data_disk_device }}"
      register: data_disk
      when: data_disk_device is defined

    - name: Check if data disk is already formatted
      command: blkid {{ data_disk_device }}
      register: blkid_result
      failed_when: false
      changed_when: false
      when: data_disk_device is defined and data_disk.stat.exists | default(false)

    - name: Format data disk
      filesystem:
        fstype: ext4
        dev: "{{ data_disk_device }}"
      when:
        - data_disk_device is defined
        - data_disk.stat.exists | default(false)
        - blkid_result.rc != 0

    - name: Create mount point
      file:
        path: "{{ data_mount_point }}"
        state: directory
        mode: "0755"
      when: data_disk_device is defined and data_disk.stat.exists | default(false)

    - name: Mount data disk
      mount:
        path: "{{ data_mount_point }}"
        src: "{{ data_disk_device }}"
        fstype: ext4
        opts: defaults
        state: mounted
      when: data_disk_device is defined and data_disk.stat.exists | default(false)
