---
# Playbook: Export K3s kubeconfig to local machine
# - Copy kubeconfig from first K3s node
# - Replace server URL with VIP address
# - Save to ~/.kube/config or custom location

- name: Export K3s Kubeconfig
  hosts: k3s_servers[0] # Use first node only
  become: true
  vars_files:
    - ../group_vars/k3s_servers.yml
    - ../group_vars/all/vault.yml

  vars:
    local_kubeconfig_path: "~/.kube/config"
    kubeconfig_context_name: "k3s-homelab"

  tasks:
    - name: Read kubeconfig from remote node
      slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_content

    - name: Get VIP address
      set_fact:
        vip_address: "{{ vip_address }}"

    - name: Decode kubeconfig
      set_fact:
        kubeconfig_raw: "{{ kubeconfig_content.content | b64decode }}"

    - name: Process kubeconfig (replace server URL with VIP)
      set_fact:
        processed_kubeconfig: "{{ kubeconfig_raw | regex_replace('server: https://[^:]+:6443', 'server: https://' + vip_address + ':6443') }}"

    - name: Create local .kube directory
      file:
        path: "{{ local_kubeconfig_path | dirname | expanduser }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      become: no
      run_once: true

    - name: Backup existing kubeconfig if exists
      copy:
        src: "{{ local_kubeconfig_path | expanduser }}"
        dest: "{{ local_kubeconfig_path | expanduser }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
      delegate_to: localhost
      become: no
      run_once: true
      when: (local_kubeconfig_path | expanduser) is file
      failed_when: false

    - name: Write kubeconfig to local file
      copy:
        content: "{{ processed_kubeconfig }}"
        dest: "{{ local_kubeconfig_path | expanduser }}"
        mode: "0600"
      delegate_to: localhost
      become: no
      run_once: true

    - name: Display kubeconfig location
      debug:
        msg:
          - "Kubeconfig đã được export thành công!"
          - "Location: {{ local_kubeconfig_path | expanduser }}"
          - "Server: https://{{ vip_address }}:6443"
          - ""
          - "Để sử dụng:"
          - "  kubectl get nodes"
          - "  kubectl get pods --all-namespaces"
          - ""
          - "If you want to use a specific context:"
          - "  export KUBECONFIG={{ local_kubeconfig_path | expanduser }}"
      run_once: true
