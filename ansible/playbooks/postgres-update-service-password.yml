---
# Playbook: Update password for service user
# Usage: ansible-playbook playbooks/postgres-update-service-password.yml -e "service_name=auth user_type=prod new_password=newpass123"

- name: Update service user password
  hosts: postgres_servers
  become: true

  vars_files:
    - ../group_vars/postgres_servers.yml

  vars:
    service_name: "{{ service_name }}"
    user_type: "{{ user_type }}"  # master, prod, or readonly
    new_password: "{{ new_password }}"

  tasks:
    - name: Validate required parameters
      fail:
        msg: |
          Missing required parameters!
          Usage: -e "service_name=auth user_type=prod new_password=newpass123"
          
          user_type must be: master, prod, or readonly
      when: >
        service_name is not defined or service_name == "" or
        user_type is not defined or user_type not in ['master', 'prod', 'readonly'] or
        new_password is not defined or new_password == ""

    - name: Create password update script
      copy:
        dest: /tmp/update-password-{{ service_name }}-{{ user_type }}.sql
        content: |
          -- Update password for {{ service_name }}_{{ user_type }}
          ALTER USER {{ service_name }}_{{ user_type }} WITH PASSWORD '{{ new_password }}';
          
          -- Verify user exists
          SELECT 
            '{{ service_name }}_{{ user_type }}' as username,
            CASE WHEN rolcanlogin THEN '‚úÖ Can login' ELSE '‚ùå Cannot login' END as status
          FROM pg_roles 
          WHERE rolname = '{{ service_name }}_{{ user_type }}';
        mode: "0600"  # Secure file permissions

    - name: Execute password update
      shell: |
        docker exec -i pg15_prod psql -U postgres < /tmp/update-password-{{ service_name }}-{{ user_type }}.sql
      register: sql_result
      no_log: true  # Don't log password

    - name: Cleanup SQL script
      file:
        path: /tmp/update-password-{{ service_name }}-{{ user_type }}.sql
        state: absent

    - name: Show result
      debug:
        msg: |
          ‚úÖ Password updated successfully!

          üë§ User: {{ service_name }}_{{ user_type }}
          üîí New password: ********

          üîå Updated connection string:
            postgresql://{{ service_name }}_{{ user_type }}:{{ new_password }}@{{ ansible_host }}:5432/smap
