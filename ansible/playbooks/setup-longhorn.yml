---
# Playbook: Install Longhorn for Distributed Block Storage
# Usage: ansible-playbook playbooks/setup-longhorn.yml

- name: Install Longhorn Prerequisites
  hosts: k3s_servers
  become: true
  tasks:
    - name: Install open-iscsi (required by Longhorn)
      apt:
        name: open-iscsi
        state: present
        update_cache: yes

    - name: Start and enable iscsid service
      systemd:
        name: iscsid
        state: started
        enabled: yes

- name: Install Longhorn via Helm
  hosts: k3s_servers[0]
  become: true
  vars:
    longhorn_version: "v1.5.3"
    longhorn_data_path: "/mnt/longhorn"

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    - name: Add Longhorn Helm repo
      command: helm repo add longhorn https://charts.longhorn.io
      changed_when: false

    - name: Update Helm repos
      command: helm repo update
      changed_when: false

    - name: Create longhorn-system namespace
      command: kubectl create namespace longhorn-system
      register: lh_ns
      failed_when: false
      changed_when: lh_ns.rc == 0

    - name: Check if Longhorn is installed
      command: helm status longhorn -n longhorn-system
      register: lh_status
      failed_when: false
      changed_when: false

    - name: Install Longhorn
      shell: |
        helm install longhorn longhorn/longhorn \
          --namespace longhorn-system \
          --version {{ longhorn_version }} \
          --set defaultSettings.defaultDataPath="{{ longhorn_data_path }}" \
          --set defaultSettings.replicaSoftAntiAffinity=false \
          --set defaultSettings.storageMinimalAvailablePercentage=10
      when: lh_status.rc != 0

    - name: Wait for Longhorn deployments to be ready
      shell: kubectl wait --for=condition=Available deployment --all -n longhorn-system --timeout=600s
      when: lh_status.rc != 0
      register: lh_wait
      failed_when: false

    - name: Create Ingress for Longhorn UI
      copy:
        dest: /tmp/longhorn-ingress.yaml
        content: |
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: longhorn-ingress
            namespace: longhorn-system
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web
          spec:
            rules:
            - host: longhorn.tantai.dev
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: longhorn-frontend
                      port:
                        number: 80
        mode: "0644"

    - name: Apply Ingress
      command: kubectl apply -f /tmp/longhorn-ingress.yaml

    - name: Get Longhorn status
      shell: kubectl get pods -n longhorn-system
      register: longhorn_pods
      changed_when: false

    - name: Show Longhorn info
      debug:
        msg: |
          Longhorn is installed!
          
          Data Path: {{ longhorn_data_path }}
          UI: http://longhorn.tantai.dev (add to /etc/hosts)
          
          Pods status:
          {{ longhorn_pods.stdout }}
