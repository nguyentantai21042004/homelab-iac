---
# Playbook: Setup Immich Photo Management

- name: Setup Immich Photo Management System
  hosts: immich_servers
  become: true
  vars_files:
    - ../group_vars/immich_servers.yml
    - ../group_vars/all/vault.yml

  tasks:
    # ===== System Optimization =====
    - name: Configure kernel for optimal performance
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: "vm.swappiness", value: "10" }
        - { name: "vm.dirty_ratio", value: "15" }
        - { name: "vm.dirty_background_ratio", value: "5" }

    # ===== Docker Installation =====
    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Install Docker from Ubuntu repository
      apt:
        name:
          - docker.io
          - docker-compose
        state: present
        update_cache: yes

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    # ===== Format and Mount Data Disk =====
    - name: Check if data disk is formatted
      command: blkid {{ data_disk_device }}
      register: blkid_result
      failed_when: false
      changed_when: false

    - name: Format data disk with ext4
      filesystem:
        fstype: ext4
        dev: "{{ data_disk_device }}"
      when: blkid_result.rc != 0

    - name: Create mount point
      file:
        path: "{{ immich_data_path }}"
        state: directory
        mode: "0755"

    - name: Mount data disk
      mount:
        path: "{{ immich_data_path }}"
        src: "{{ data_disk_device }}"
        fstype: ext4
        opts: defaults,noatime
        state: mounted

    # ===== Configure Docker Daemon =====
    - name: Create Docker daemon config for log rotation
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
        mode: "0644"
      notify: Restart Docker

    # ===== Create Immich Directory Structure =====
    - name: Create Immich data directories on data disk
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ immich_upload_location }}"
        - "{{ immich_db_location }}"

    - name: Create Immich stack directory
      file:
        path: "{{ immich_stack_path }}"
        state: directory
        mode: "0755"

    # ===== Copy Configuration Files =====
    - name: Copy environment file
      template:
        src: ../templates/immich/.env.j2
        dest: "{{ immich_stack_path }}/.env"
        mode: "0600"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Copy docker-compose.yml
      template:
        src: ../templates/immich/docker-compose.yml.j2
        dest: "{{ immich_stack_path }}/docker-compose.yml"
        mode: "0644"

    # ===== Start Immich Services =====
    - name: Stop existing containers
      shell: |
        cd {{ immich_stack_path }}
        docker-compose down || true
      register: docker_stop_result

    - name: Pull latest Immich images
      shell: |
        cd {{ immich_stack_path }}
        docker-compose pull
      register: docker_pull_result

    - name: Start Immich containers
      shell: |
        cd {{ immich_stack_path }}
        docker-compose up -d
      register: docker_compose_result

    - name: Wait for Immich server to be ready
      wait_for:
        port: "{{ immich_port }}"
        delay: 15
        timeout: 120

    # ===== WireGuard VPN Setup =====
    - name: Create WireGuard stack directory
      file:
        path: "{{ wireguard_stack_path }}"
        state: directory
        mode: "0755"
      when: wireguard_enabled | default(false)

    - name: Copy WireGuard docker-compose.yml
      template:
        src: ../templates/wireguard/docker-compose.yml.j2
        dest: "{{ wireguard_stack_path }}/docker-compose.yml"
        mode: "0644"
      when: wireguard_enabled | default(false)

    - name: Start WireGuard VPN
      shell: |
        cd {{ wireguard_stack_path }}
        docker-compose up -d
      when: wireguard_enabled | default(false)

    - name: Wait for WireGuard UI to be ready
      wait_for:
        host: localhost
        port: "{{ wireguard_ui_port }}"
        delay: 5
        timeout: 60
      when: wireguard_enabled | default(false)

    # ===== Final Information =====
    - name: Show Immich access information
      debug:
        msg: |
          Immich Photo Management is running!

          Web UI: http://{{ ansible_host }}:{{ immich_port }}

          Data locations:
          - Photos/Videos: {{ immich_upload_location }}
          - Database: {{ immich_db_location }}

          Stack path: {{ immich_stack_path }}

          {% if wireguard_enabled | default(false) %}
          WireGuard VPN is running!
          - Web UI: http://{{ ansible_host }}:{{ wireguard_ui_port }}
          - VPN Port: {{ wireguard_port }}/udp

          {% endif %}
          Next steps:
          1. Truy cập Web UI và tạo tài khoản Admin đầu tiên
          2. Cài đặt Immich Mobile App trên iPhone 11
          3. Cấu hình auto-backup từ iPhone
          {% if wireguard_enabled | default(false) %}
          4. Tạo WireGuard peer cho iPhone tại http://{{ ansible_host }}:{{ wireguard_ui_port }}
          5. Cấu hình On-Demand VPN trên iPhone
          {% endif %}

  handlers:
    - name: Restart Docker
      service:
        name: docker
        state: restarted
