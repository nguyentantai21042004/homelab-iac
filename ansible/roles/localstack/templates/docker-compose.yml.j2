version: "3.8"

services:
  localstack:
    container_name: localstack_pro
    image: localstack/localstack-pro:latest
    # TỐI ƯU 1: Dùng Host Network. Container dùng chung IP với VM.
    # Không cần map ports, performance mạng đạt mức tối đa.
    network_mode: host 
    
    environment:
      # --- Authentication & License ---
      - LOCALSTACK_API_KEY={{ localstack_api_key }}
      
      # --- Networking Strategy ---
      # IP của VM LocalStack để các VM khác gọi tới
      - LOCALSTACK_HOST={{ ansible_host }}
      # Domain endpoint chính
      - HOSTNAME_EXTERNAL=localstack.lab 
      
      # --- Persistence (Lưu trạng thái) ---
      - PERSISTENCE=1
      # Snapshot lưu mỗi 30p hoặc khi tắt
      - SNAPSHOT_SAVE_STRATEGY=scheduled 
      - SNAPSHOT_FLUSH_INTERVAL=1800
      
      # --- Lambda Optimization ---
      # Dùng Docker để chạy Lambda (ổn định nhất)
      - LAMBDA_EXECUTOR=docker 
      # Giữ container Lambda ấm để invoke nhanh hơn
      - LAMBDA_KEEP_WARM=1 
      # Tự động xóa container Lambda cũ sau 10p không dùng
      - LAMBDA_DOCKER_REUSE=1 
      - LAMBDA_REMOVE_CONTAINERS=true
      
      # --- Service Tuning ---
      - EAGER_SERVICE_LOADING=1
      - DEBUG=0 
      - LS_LOG=warn

    volumes:
      # Mount Docker socket để LocalStack spawn Lambda/ECS
      - "/var/run/docker.sock:/var/run/docker.sock"
      # Lưu data persistence vào ổ đĩa 100GB đã mount tại /mnt/data
      - "{{ localstack_data_volume }}:/var/lib/localstack" 
    
    restart: unless-stopped
