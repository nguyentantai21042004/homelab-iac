---
# Tasks for k3s role
# Disables swap, loads kernel modules, enables IP forwarding,
# installs K3s server with external datastore, deploys Kube-VIP
# and Traefik HelmChartConfig, and verifies node is ready.

# ===== Prerequisites =====
- name: Disable swap (K3s requirement)
  shell: |
    swapoff -a
    sed -i '/swap/d' /etc/fstab
  changed_when: false

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ k3s_kernel_modules }}"

- name: Persist kernel modules
  copy:
    dest: /etc/modules-load.d/k3s.conf
    content: |
      br_netfilter
      overlay
      ip_vs
      ip_vs_rr
      ip_vs_wrr
      ip_vs_sh
    mode: "0644"

- name: Enable IP forwarding
  sysctl:
    name: "{{ item }}"
    value: "1"
    state: present
    reload: yes
  loop: "{{ k3s_sysctl_params }}"

- name: Detect active network interface
  shell: "ip -o link show | awk -F': ' '{print $2}' | grep -E '^en|^eth' | head -1"
  register: detected_interface
  changed_when: false

- name: Set VIP interface fact
  set_fact:
    vip_interface: "{{ detected_interface.stdout }}"

# ===== Install K3s =====
- name: Check if K3s is already installed
  stat:
    path: "{{ k3s_config_path }}"
  register: k3s_installed

- name: Install K3s server
  shell: |
    curl -sfL https://get.k3s.io | sh -s - server \
      --token "{{ k3s_token }}" \
      --datastore-endpoint "{{ datastore_endpoint }}" \
      {{ extra_server_args | join(' ') }}
  environment:
    INSTALL_K3S_CHANNEL: "{{ k3s_channel }}"
  args:
    creates: "{{ k3s_config_path }}"
  register: k3s_install

- name: Wait for K3s to be ready
  wait_for:
    path: "{{ k3s_config_path }}"
    state: present
    timeout: "{{ k3s_install_timeout }}"
  when: k3s_install.changed

- name: Set kubeconfig permissions
  file:
    path: "{{ k3s_config_path }}"
    mode: "0644"

# ===== Deploy Kube-VIP =====
- name: Create manifests directory
  file:
    path: "{{ k3s_manifests_dir }}"
    state: directory
    mode: "0755"

- name: Deploy Kube-VIP DaemonSet
  template:
    src: kube-vip.yaml.j2
    dest: "{{ k3s_manifests_dir }}/kube-vip.yaml"
    mode: "0644"

# ===== Verify =====
- name: Wait for node to be Ready
  shell: kubectl get nodes {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  register: node_ready
  until: node_ready.stdout == "True"
  retries: "{{ k3s_node_ready_retries }}"
  delay: "{{ k3s_node_ready_delay }}"
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_config_path }}"

- name: Show cluster status
  shell: kubectl get nodes -o wide
  register: cluster_status
  changed_when: false
  run_once: true
  environment:
    KUBECONFIG: "{{ k3s_config_path }}"

- name: Display cluster nodes
  debug:
    msg: "{{ cluster_status.stdout_lines }}"
  run_once: true

- name: Show K3s access info
  debug:
    msg: |
      K3s cluster is ready!
      
      VIP Address: {{ vip_address }}
      Interface: {{ vip_interface }}
      
      Access cluster:
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      kubectl get nodes
      
      Or from local machine:
      scp {{ ansible_user }}@{{ ansible_host }}:/etc/rancher/k3s/k3s.yaml ~/.kube/k3s-config
      # Edit server URL to use VIP: https://{{ vip_address }}:6443
  run_once: true
